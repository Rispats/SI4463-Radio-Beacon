#include <SPI.h>

#define PIN_SDN   7
#define PIN_CSN   10
#define PIN_MOSI  MOSI
#define PIN_MISO  MISO
#define PIN_SCK   SCK


uint8_t RADIO_CONFIG[] = {

// RF_POWER_UP
  0x07, 0x02, 0x01, 0x00, 0x01, 0xC9, 0xC3, 0x80,

  // RF_GPIO_PIN_CFG
  0x08, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

  // GLOBAL_2_0
  0x08, 0x11, 0x00, 0x04, 0x00, 0x52, 0x00, 0x18, 0x30,

  // INT_CTL_2_0
  0x05, 0x11, 0x01, 0x01, 0x00, 0x00,

  // FRR_CTL_2_0
  0x07, 0x11, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00,

  // PREAMBLE_2_0
  0x05, 0x11, 0x10, 0x01, 0x04, 0x31,

  // SYNC_2_0
  0x08, 0x11, 0x11, 0x04, 0x01, 0xB4, 0x2B, 0x00, 0x00,

  // PKT_2_0
  0x0B, 0x11, 0x12, 0x07, 0x00, 0x04, 0x01, 0x08, 0xFF, 0xFF, 0x20, 0x02,

  // PKT_2_1
  0x09, 0x11, 0x12, 0x05, 0x0E, 0x07, 0x04, 0x80, 0x00, 0x80,

  // MODEM_2_0
  0x0A, 0x11, 0x20, 0x06, 0x00, 0x01, 0x00, 0x07, 0x01, 0x86, 0xA0,

  // MODEM_2_1
  0x06, 0x11, 0x20, 0x02, 0x0B, 0x00, 0x00,

  // MODEM_2_2
  0x10, 0x11, 0x20, 0x0C, 0x18, 0x00, 0x00, 0x08, 0x02, 0x80, 0x00, 0x16, 0x20, 0x00, 0xE8, 0x00, 0x5E,

  // MODEM_2_3
  0x10, 0x11, 0x20, 0x0C, 0x24, 0x05, 0x76, 0x1A, 0x02, 0xB9, 0x02, 0xC0, 0x00, 0x00, 0x12, 0x01, 0x06,

  // MODEM_2_4
  0x0A, 0x11, 0x20, 0x06, 0x30, 0x0D, 0x04, 0xA0, 0x00, 0x00, 0x60,

  // MODEM_2_5
  0x0F, 0x11, 0x20, 0x0B, 0x39, 0x15, 0x15, 0x80, 0x02, 0xFF, 0xFF, 0x00, 0x28, 0x0C, 0xA4, 0x20,

  // MODEM_2_6
  0x0D, 0x11, 0x20, 0x09, 0x45, 0x01, 0x07, 0xFF, 0x01, 0x00, 0xFF, 0x06, 0x00, 0x18,

  // MODEM_2_7
  0x06, 0x11, 0x20, 0x02, 0x50, 0x94, 0x0D,

  // MODEM_2_8
  0x06, 0x11, 0x20, 0x02, 0x54, 0x0B, 0x07,

  // MODEM_2_9
  0x09, 0x11, 0x20, 0x05, 0x5B, 0x40, 0x04, 0x20, 0x78, 0x20,

  // MODEM_CHFLT_2_0
  0x10, 0x11, 0x21, 0x0C, 0x01, 0xC4, 0x30, 0x7F, 0xF5, 0xB5, 0xB8, 0xDE, 0x05, 0x17, 0x16, 0x0C, 0x03,

  // MODEM_CHFLT_2_1
  0x09, 0x11, 0x21, 0x05, 0x0D, 0x00, 0x15, 0xFF, 0x00, 0x00,

  //POWER
  0x05, 0x11, 0x22, 0x01, 0x03, 0x7F,

  // FREQ_CONTROL_2_0
  0x0C, 0x11, 0x40, 0x08, 0x00, 0x3F, 0x0A, 0x51, 0xEB, 0xCC, 0xCD, 0x20, 0xFA


};

void sendCommand(const uint8_t* data, uint8_t len) {
  digitalWrite(PIN_CSN, LOW);
  for (uint8_t i = 0; i < len; i++) SPI.transfer(data[i]);
  digitalWrite(PIN_CSN, HIGH);
}

bool waitCTS() {
  for (uint8_t i = 0; i < 100; i++) {
    digitalWrite(PIN_CSN, LOW);
    SPI.transfer(0x44);
    delayMicroseconds(20);
    uint8_t cts = SPI.transfer(0x00);
    digitalWrite(PIN_CSN, HIGH);
    if (cts == 0xFF) return true;
    delay(5);
  }
  return false;
}

void si4463_init() {
  digitalWrite(PIN_SDN, HIGH); delay(50);
  digitalWrite(PIN_SDN, LOW);  delay(50);
  digitalWrite(PIN_CSN, HIGH);

  for (uint16_t i = 0; i < sizeof(RADIO_CONFIG); ) {
    uint8_t len = RADIO_CONFIG[i++];
    if (len == 0x00) break;
    sendCommand(&RADIO_CONFIG[i], len);
    i += len;
    waitCTS();
  }
}

void sendBit(uint8_t data) {
  uint8_t fifo[] = { 0x66, data };  // 0x66 = WRITE_TX_FIFO
  sendCommand(fifo, sizeof(fifo));
  waitCTS();

  const uint8_t tx_cmd[] = { 0x31, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00 }; // START_TX: channel 0, 1-byte packet
  sendCommand(tx_cmd, sizeof(tx_cmd));
  waitCTS();
}

void setup() {
  pinMode(PIN_SDN, OUTPUT);
  pinMode(PIN_CSN, OUTPUT);
  digitalWrite(PIN_CSN, HIGH);

  Serial.begin(115200);
  SPI.begin();
  SPI.beginTransaction(SPISettings(4000000, MSBFIRST, SPI_MODE0));

  si4463_init();
  Serial.println("Transmitter ready...");
}
  uint8_t bit =  0xFF;

void loop() {
  
  Serial.println(bit, BIN);
  sendBit(bit);

  delay(10); // Send every 1 second
}
